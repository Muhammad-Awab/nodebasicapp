name: CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
          HOSTNAME: ${{ secrets.HOSTNAME }}
          USER_NAME: ${{ secrets.USER }}

        run: |
          echo "$PRIVATE_KEY" > private_key
          chmod 600 private_key
          scp -o StrictHostKeyChecking=no -i private_key -r . ${USER_NAME}@${HOSTNAME}:/home/ec2-user/
          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} '
            DIR="/home/ubuntu/server"
            pm2 delete all
            cd /home/ec2-user

            if [ ! -d $DIR ]; then
              mkdir server &&
              git clone https://github.com/Muhammad-Awab/nodebasic.git &&
              cd nodebasic &&
              npm install
            else
              cd server
            fi

            git checkout master &&
            git fetch --all &&
            git reset --hard origin/main &&
            git pull origin main &&
            pm2 start app.js
          '
